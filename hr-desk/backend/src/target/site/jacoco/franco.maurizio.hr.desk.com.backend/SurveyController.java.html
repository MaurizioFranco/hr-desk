<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SurveyController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">hr-desk.backend17</a> &gt; <a href="index.source.html" class="el_package">franco.maurizio.hr.desk.com.backend</a> &gt; <span class="el_source">SurveyController.java</span></div><h1>SurveyController.java</h1><pre class="source lang-java linenums">package franco.maurizio.hr.desk.com.backend;

import java.io.IOException;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;
import java.util.Properties;

import jakarta.validation.Valid;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import franco.maurizio.hr.desk.com.persistence.entity.CandidateSurveyToken;
import franco.maurizio.hr.desk.com.persistence.entity.CeReProAbstractEntity;
import franco.maurizio.hr.desk.com.persistence.entity.Survey;
import franco.maurizio.hr.desk.com.persistence.entity.custom.CustomErrorType;
import franco.maurizio.hr.desk.com.persistence.repository.SurveyRepository;
import franco.maurizio.hr.desk.com.persistence.repository.candidatesurveytoken.CandidateSurveyTokenRepository;
import franco.maurizio.hr.desk.com.rest.response.ResponseQuestion;
import franco.maurizio.hr.desk.com.rest.response.StartSurveyResponse;
import franco.maurizio.hr.desk.com.service.SurveyService;

/**
 * @author Marco Fulgosi
 *
 */

@RestController
@RequestMapping(&quot;/api/v1/survey&quot;)
<span class="fc" id="L43">public class SurveyController {</span>

<span class="fc" id="L45">	public static final Logger logger = LoggerFactory.getLogger(SurveyController.class);</span>
	

	@Autowired
	private SurveyRepository surveyRepository;
	@Autowired
	private CandidateSurveyTokenRepository candidateSurveyTokenRepository;
<span class="fc" id="L52">	@Autowired</span>
	private SurveyService surveyService = new SurveyService();

	@Autowired
	public void setSurveyJpaRepository(SurveyRepository surveyRepository) {
<span class="fc" id="L57">		this.surveyRepository = surveyRepository;</span>
<span class="fc" id="L58">	}</span>
	
	/****** SELECT-ALL ******/
	@GetMapping(&quot;/&quot;)
	public ResponseEntity&lt;List&lt;Survey&gt;&gt; listAllSurvey() {
<span class="fc" id="L63">		List&lt;Survey&gt; survey = surveyRepository.findAll();</span>
		
<span class="pc bpc" id="L65" title="1 of 2 branches missed.">		if (survey.isEmpty()) {</span>

<span class="nc" id="L67">			return new ResponseEntity&lt;&gt;(HttpStatus.NO_CONTENT);</span>
		}

<span class="fc" id="L70">		return new ResponseEntity&lt;&gt;(survey, HttpStatus.OK);</span>
	}
	
	
	/****** INSERT ******/
	@PostMapping(value = &quot;/&quot;, consumes = MediaType.APPLICATION_JSON_VALUE)
	public ResponseEntity&lt;CeReProAbstractEntity&gt; createSurvey(@Valid @RequestBody final Survey survey) {
		
<span class="fc" id="L78">		logger.info(&quot;Creating survey : {}&quot;, survey);</span>
<span class="fc" id="L79">		surveyRepository.save(survey);</span>
<span class="fc" id="L80">		return new ResponseEntity&lt;&gt;(survey, HttpStatus.CREATED);</span>
	}
	
	/****** SELECT BY ID ******/
	@GetMapping(&quot;/{id}&quot;)
	public ResponseEntity&lt;CeReProAbstractEntity&gt; getSurveyById(@PathVariable final Long id) {
<span class="fc" id="L86">	Optional&lt;Survey&gt; survey = surveyRepository.findById(id);</span>
	
<span class="pc bpc" id="L88" title="1 of 2 branches missed.">	if (survey.isEmpty()) {</span>
	
<span class="nc" id="L90">	return new ResponseEntity&lt;&gt;(new CustomErrorType(&quot;Survey with id &quot; + id + &quot; not found&quot;),HttpStatus.NOT_FOUND);</span>
	}
	
<span class="fc" id="L93">	return new ResponseEntity&lt;&gt;(survey.get(), HttpStatus.OK);</span>
	}
	
	
	/****** UPDATE ******/
	@PutMapping(value = &quot;/{id}&quot;, consumes = MediaType.APPLICATION_JSON_VALUE)
	public ResponseEntity&lt;CeReProAbstractEntity&gt; updateSurvay(@PathVariable final Long id, @RequestBody Survey survey) {

		// fetch user based on id and set it to currentUser object of type UserDTO

<span class="fc" id="L103">		Optional&lt;Survey&gt; currentSurvey = surveyRepository.findById(id);</span>

<span class="pc bpc" id="L105" title="1 of 2 branches missed.">		if (currentSurvey.isEmpty()) {</span>
<span class="nc" id="L106">			return new ResponseEntity&lt;&gt;(new CustomErrorType(&quot;Unable to upate. User with id &quot; + id + &quot; not found.&quot;), HttpStatus.NOT_FOUND);</span>
		}
		// update currentUser object data with user object data

<span class="fc" id="L110">		currentSurvey.get().setLabel(survey.getLabel());</span>
<span class="fc" id="L111">		currentSurvey.get().setDescription(survey.getDescription());</span>
<span class="fc" id="L112">		currentSurvey.get().setTime(survey.getTime());</span>
		
		// save currentUser obejct

<span class="fc" id="L116">		surveyRepository.saveAndFlush(currentSurvey.get());</span>

		// return ResponseEntity object

<span class="fc" id="L120">		return new ResponseEntity&lt;&gt;(currentSurvey.get(), HttpStatus.OK);</span>
	}


	/****** DELETE ******/
	@DeleteMapping(&quot;/{id}&quot;)
	public ResponseEntity&lt;CeReProAbstractEntity&gt; deleteSurvey(@PathVariable final Long id) {
<span class="fc" id="L127">		Optional&lt;Survey&gt; survey = surveyRepository.findById(id);</span>
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">		if (survey.isEmpty()) {</span>
<span class="nc" id="L129">			return new ResponseEntity&lt;&gt;(new CustomErrorType(&quot;Unable to delete. SurveyReply with id &quot; + id + &quot; not found.&quot;), HttpStatus.NOT_FOUND);</span>
		}
<span class="fc" id="L131">		surveyRepository.delete(survey.get());</span>
<span class="fc" id="L132">		return new ResponseEntity&lt;&gt;(HttpStatus.NO_CONTENT);</span>
	}
	
	
	/**
	 * recuperare tutte le question alle quali il candidato deve rispondere.
	 * 
	 * @param token --&gt; della tabella candidatesurveytokens 
	 * @return
	 */
	@GetMapping(&quot;/getSurveyForCandidate/{token}&quot;)
	public ResponseEntity&lt;StartSurveyResponse&gt; getSurveyForCandidate(@PathVariable final String token){
<span class="nc" id="L144">		logger.info(&quot;getSurveyForCandidate - START - token: &quot; + token);</span>
<span class="nc" id="L145">		StartSurveyResponse toSend = new StartSurveyResponse();</span>
		/* lets take the userSurveyToken associated and check if it exists */
<span class="nc" id="L147">		CandidateSurveyToken candidateSurveyToken = candidateSurveyTokenRepository.findByGeneratedToken(token);</span>
<span class="nc" id="L148">		logger.info(&quot;getSurveyForCandidate - DEBUG - candidateSurveyToken: &quot; + candidateSurveyToken);</span>
<span class="nc" id="L149">		Properties props = new Properties();</span>
		try {
<span class="nc" id="L151">			props.load(SurveyController.class.getClassLoader().getResourceAsStream(&quot;messages.properties&quot;));</span>
<span class="nc" id="L152">		} catch (IOException e) {</span>
<span class="nc" id="L153">			logger.error(&quot;Error &quot;,e);</span>
<span class="nc" id="L154">		}</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">		if(candidateSurveyToken != null) {</span>
<span class="nc" id="L156">			Optional&lt;Survey&gt; survey = surveyRepository.findById(candidateSurveyToken.getSurveyId());</span>
<span class="nc" id="L157">			logger.info(&quot;getSurveyForCandidate - DEBUG - survey.isPresent(): &quot; + survey.isPresent() + &quot; - candidateSurveyToken.getSurveyId(): &quot; + candidateSurveyToken.getSurveyId());</span>
<span class="nc" id="L158">			Boolean expired = candidateSurveyToken.isExpired();</span>
<span class="nc" id="L159">			logger.info(&quot;getSurveyForCandidate - DEBUG - userTokenSurvey.isExpired(): &quot; + expired);</span>
			/* check on expiration date */
<span class="nc" id="L161">			LocalDateTime expDate = candidateSurveyToken.getExpirationDateTime();</span>
<span class="nc" id="L162">			logger.info(&quot;getSurveyForCandidate - DEBUG - expDate.isBefore(LocalDateTime.now()): &quot; + expDate.isBefore(LocalDateTime.now()));</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">			if(expDate.isBefore(LocalDateTime.now())) {</span>
<span class="nc" id="L164">				String tokenExpired = props.getProperty(&quot;token.message.expired&quot;);</span>
<span class="nc" id="L165">				candidateSurveyToken.setExpired(true);</span>
<span class="nc" id="L166">				candidateSurveyTokenRepository.save(candidateSurveyToken);</span>
				
<span class="nc" id="L168">				toSend.setErrorCode(2); /* if the token is expired -&gt; errorCode = 2 */</span>
<span class="nc" id="L169">				toSend.setExpiredToken(tokenExpired);</span>
<span class="nc" id="L170">				return new ResponseEntity&lt;StartSurveyResponse&gt;(toSend, HttpStatus.OK);</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">			} else if(expired) {//TODO</span>
//			if (false) {//only for testing frontend....
<span class="nc" id="L173">				toSend.setErrorCode(2); /* if the token is expired -&gt; errorCode = 2 */</span>
<span class="nc" id="L174">				String tokenExpired = props.getProperty(&quot;token.message.expired&quot;);</span>
<span class="nc" id="L175">				toSend.setExpiredToken(tokenExpired);</span>
<span class="nc" id="L176">				return new ResponseEntity&lt;StartSurveyResponse&gt;(toSend, HttpStatus.OK);</span>
			} else {
					
<span class="nc" id="L179">					List&lt;ResponseQuestion&gt; listaResponseQuestion = surveyService.getAllRelatedQuestionsBySurveyIdOrderedByPosition(candidateSurveyToken.getSurveyId());</span>
<span class="nc" id="L180">					logger.info(&quot;getSurveyForCandidate - DEBUG - listaResponseQuestion.size(): &quot; + listaResponseQuestion.size()); </span>
<span class="nc" id="L181">					toSend.setQuestions(listaResponseQuestion);</span>
			}
			
<span class="nc" id="L184">			toSend.setSurveyId(candidateSurveyToken.getSurveyId());</span>
<span class="nc" id="L185">			toSend.setCandidateId(candidateSurveyToken.getCandidateId());</span>
<span class="nc" id="L186">			toSend.setCandidateTokenId(candidateSurveyToken.getId());</span>
<span class="nc" id="L187">			toSend.setTime(survey.get().getTime());</span>
<span class="nc" id="L188">			String afterSurvey = props.getProperty(&quot;survey.message.after&quot;);</span>
<span class="nc" id="L189">			logger.info(&quot;afterSurvey&quot; + afterSurvey);</span>
<span class="nc" id="L190">			toSend.setAfterSurvey(afterSurvey);</span>
<span class="nc" id="L191">			return new ResponseEntity&lt;StartSurveyResponse&gt;(toSend,HttpStatus.OK);</span>
			
			
		}
		
		/* if there's no such token -&gt; errorCode = 1 */
<span class="nc" id="L197">		toSend.setErrorCode(1);</span>
<span class="nc" id="L198">		String invalidToken = props.getProperty(&quot;token.message.invalid&quot;); </span>
<span class="nc" id="L199">		toSend.setInvalidToken(invalidToken);</span>
<span class="nc" id="L200">		return new ResponseEntity&lt;StartSurveyResponse&gt;(toSend, HttpStatus.NOT_FOUND);</span>
	}
		
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>