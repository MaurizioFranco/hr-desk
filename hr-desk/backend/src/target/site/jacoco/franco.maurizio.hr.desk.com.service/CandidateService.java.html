<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CandidateService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">hr-desk.backend17</a> &gt; <a href="index.source.html" class="el_package">franco.maurizio.hr.desk.com.service</a> &gt; <span class="el_source">CandidateService.java</span></div><h1>CandidateService.java</h1><pre class="source lang-java linenums">/**
 * 
 */
package franco.maurizio.hr.desk.com.service;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.NoSuchFileException;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.ZoneId;
import java.util.Arrays;
import java.util.Date;
import java.util.List;
import java.util.Optional;
import java.util.Random;
import java.util.StringTokenizer;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import franco.maurizio.hr.desk.com.persistence.entity.Candidate;
import franco.maurizio.hr.desk.com.persistence.entity.CandidateStates;
import franco.maurizio.hr.desk.com.persistence.entity.custom.CandidateCustom;
import franco.maurizio.hr.desk.com.persistence.entity.custom.ListedCandidateCustom;
import franco.maurizio.hr.desk.com.persistence.repository.candidate.CandidateRepository;
import franco.maurizio.hr.desk.com.rest.request.candidate.RequestCandidateCustom;
import franco.maurizio.hr.desk.com.rest.request.candidate.RequestUpdateCandidateCustom;
import franco.maurizio.hr.desk.com.service.exception.CandidateNotFoundException;
import jakarta.persistence.NoResultException;

/**
 * 
 * 
 * @author maurizio.franco@ymail.com
 *
 */
@Service 
<span class="fc" id="L49">public class CandidateService {</span>
	
	@Value(&quot;${app.folder.candidate.profile.img}&quot;)
	public String IMG_DIR;
	@Value(&quot;${app.folder.candidate.cv}&quot;)
	public String CV_DIR;	
	
<span class="fc" id="L56">	public static final Logger logger = LoggerFactory.getLogger(CandidateService.class);</span>
	
	@Autowired
	private CandidateRepository candidateRepository;
	@Autowired
	private CoursePageService coursePageService ;
	/**
	 * Gets all candidates entries from table
	 * 
	 * @return List&lt;Candidate&gt;
	 */
	public List&lt;Candidate&gt; getAll () {
<span class="nc" id="L68">		logger.info(&quot;CandidateService.getAll - START&quot;);</span>
<span class="nc" id="L69">		return candidateRepository.findAll();</span>
	}
	
	/**
	 * Try to delete all instances into candidate table
	 * 
	 * @return long
	 */
	public void deleteAll () {
<span class="fc" id="L78">		logger.info(&quot;deleteAll - START&quot;);</span>
<span class="fc" id="L79">		candidateRepository.deleteAll();</span>
<span class="fc" id="L80">	}</span>
	
//	/**
//	 * Gets all candidates custom(Candidates + Users)
//	 * COMMENTED ON 24/01/20 because no more used!!!!!!!! by maurizio
//	 * @return List&lt;CandidateCustom&gt;
//	 */
//	public List&lt;CandidateCustom&gt; getAllCustom () {
//		log.info(&quot;CandidateService.getAllCustom - START&quot;);
//		return candidateRepository.getAllCustomCandidates();
//	}
	
//	/**
//	 * Gets all candidates custom(Candidates + Users) in paginated version list
//	 * 
//	 * @param Pageable p, page info
//	 * @return Page&lt;CandidateCustom&gt;
//	 */
//	public Page&lt;CandidateCustom&gt; getAllCustomPaginated (Pageable p) {
//		log.info(&quot;CandidateService.getAllCustomPaginated - START - with pageable info {}&quot;, p);
//		return candidateRepository.getAllCustomCandidatesPaginated(p);
//	}
	
	/**
	 * Gets all candidates custom(Candidates + Users) in paginated version list, filtering by course code field
	 * 
	 * @param Pageable p, page info
	 * @param String courseCode, string value for course code field
	 * @return Page&lt;ListedCandidateCustom&gt;
	 */
	public Page&lt;ListedCandidateCustom&gt; getAllCustomPaginatedByCourseCode (Pageable p, String courseCode) {
<span class="nc" id="L111">		logger.info(&quot;CandidateService.getAllCustomPaginatedByCourseCode - START - with pageable info {0} and course code: {1}&quot;, p, courseCode);</span>
<span class="nc" id="L112">		return candidateRepository.getAllCustomCandidatesPaginatedByCourseCode(p, courseCode);</span>
	}
	
	/**
	 * Gets all candidates custom(Candidates + Users) by course code field
	 * 
	 * @return List&lt;CandidateCustom&gt;
	 */
	public List&lt;ListedCandidateCustom&gt; getAllByCourseCode (String courseCode) {
<span class="nc" id="L121">		logger.info(&quot;CandidateService.getAllByCourseCode - START with given course code {}&quot;, courseCode);</span>
<span class="nc" id="L122">		List&lt;ListedCandidateCustom&gt; items = candidateRepository.findByCourseCode(courseCode);</span>
<span class="nc" id="L123">		return items;</span>
	}
	
	/**
	 * Insert new candidate entity 
	 */
	public Candidate insert (Candidate c) {
<span class="fc" id="L130">		logger.info(&quot;insert() - START - with given candidate {}&quot;, c);</span>
//		c.setCandidacyDateTime(LocalDateTime.now());
//		c.setCandidateStatesId(CandidateStates.DEFAULT_INSERTING_STATUS_CODE);
//		logger.info(&quot;CandidateService.insert DEBUG with given candidate {}&quot;, c);
<span class="fc" id="L134">		return candidateRepository.save(c);</span>
	}
	
	/**
	 * Update candidate entity 
	 * 
	 */
	public Candidate update (Candidate c) {
<span class="nc" id="L142">		logger.info(&quot;update() - START -with given candidate {}&quot;, c);</span>
<span class="nc" id="L143">		return candidateRepository.save(c);</span>
	}
	
	/**
	 * Retrieve candidate by id
	 * 
	 * @param id of the candidate to retrieve
	 * @return candidate entity
	 */
	public Optional&lt;Candidate&gt; getById(long id) {
<span class="nc" id="L153">		logger.info(&quot;getById() - START with given id {}&quot;, id);</span>
<span class="nc" id="L154">		return candidateRepository.findById(id);</span>
		
	}
	
	/**
	 * Retrieve candidate by id
	 * 
	 * @param id of the candidate to retrieve
	 * @return candidate entity
	 */
	public CandidateCustom getCustomById(long id) {
<span class="fc" id="L165">		logger.info(&quot;getCustomById() - START - with given id {}&quot;, id);</span>
<span class="fc" id="L166">		CandidateCustom candiateToReturn = null ;</span>
        try {
<span class="fc" id="L168">        	candiateToReturn = candidateRepository.getSingleCustomCandidate(id);</span>
<span class="fc" id="L169">        } catch (NoResultException e) {</span>
<span class="fc" id="L170">        	logger.info(e.getMessage());</span>
<span class="fc" id="L171">			logger.info(&quot;getCustomById() - INFO - No candidate found for id {}&quot;, id);</span>
<span class="fc" id="L172">        }</span>
<span class="fc" id="L173">		return candiateToReturn ;</span>
		
	}
	
	/**
	 * Delete candidate by id
	 * 
	 * @param id of the candidate to delete
	 */
	public void deleteById(long id) {
<span class="nc" id="L183">		logger.info(&quot;CandidateService.deleteById START with given id {}&quot;, id);</span>
<span class="nc" id="L184">		candidateRepository.deleteById(id);</span>
<span class="nc" id="L185">	}</span>
	
//	/**
//	 * Insert new candidate custom by inserting into candidates and users tables.
//	 * 
//	 * @param CandidateCustom cc, candidate custom info to insert
//	 */
//	public void insertCustom (CandidateCustom cc) {
//		log.info(&quot;CandidateService.insert START with given candidate {}&quot;, c);
//		c.setCandidacyDateTime(LocalDateTime.now());
//		c.setCandidateStatesId(CandidateStates.DEFAULT_INSERTING_STATUS_CODE);
//		log.info(&quot;CandidateService.insert DEBUG with given candidate {}&quot;, c);
//		candidateRepository.save(c);
//	}
	
	public long getRegisteredCandidatesInDate(LocalDate date) {
<span class="nc" id="L201">		logger.info(&quot;getRegisteredCandidatesInDate - START&quot;);</span>
<span class="nc" id="L202">		LocalDateTime start = LocalDateTime.of(date.getYear(), date.getMonth(), date.getDayOfMonth(), 0, 0, 0);</span>
<span class="nc" id="L203">		LocalDateTime end = LocalDateTime.of(date.getYear(), date.getMonth(), date.getDayOfMonth(), 23, 59, 59);</span>
<span class="nc" id="L204">		long count = candidateRepository.getCandidateCountWithRegdateInPeriod(start, end);</span>
	
<span class="nc" id="L206">		logger.info(&quot;getRegisteredCandidatesInDate - END - with registered candidates: &quot; + count);</span>
<span class="nc" id="L207">		return count;</span>
	}
	
	/**
	 * 
	 * Returns number of candidates registered from days ago number received.
	 * 
	 * @param daysAgo
	 * @return
	 * @author orlando
	 * @author m.franco@proximanetwork.it
	 */
	public long getRegisteredCandidatesFromDaysAgo(long daysAgo) {
<span class="nc" id="L220">		logger.info(&quot;getRegisteredCandidatesFromDaysAgo - START - daysAgo: &quot; + daysAgo);</span>
<span class="nc" id="L221">		long count = 0;</span>
<span class="nc" id="L222">		LocalDate date = LocalDate.now();</span>
		//User currentUser;
<span class="nc bnc" id="L224" title="All 2 branches missed.">		for(int i = 0; i &lt; daysAgo; i++) {</span>
<span class="nc" id="L225">			LocalDate day = date.minusDays(i);</span>
<span class="nc" id="L226">			count += getRegisteredCandidatesInDate(day);		</span>
		}
<span class="nc" id="L228">		logger.info(&quot;getRegisteredCandidatesFromDaysAgo - END - return: &quot; + count);</span>
<span class="nc" id="L229">		return count;</span>
	}
	
	/**
	 * Invoked by CandidateCustomController.insert, provides to upload image and cv files and fill a new Candidate entity, 
	 * than call CandidateService.insert method to persist the entity. 
	 * 
	 * @return Candidate, inserted entity
	 */
	public Candidate createNewCandidate (RequestCandidateCustom requestCandidateCustom) {
<span class="nc" id="L239">		logger.info(&quot;createNewCandidate - START - with requestCandidateCustom {}&quot;, requestCandidateCustom);</span>
		
<span class="nc" id="L241">		Candidate candidateToInsert = new Candidate () ;</span>
<span class="nc" id="L242">		candidateToInsert.setInsertedBy(requestCandidateCustom.getInsertedBy());</span>
<span class="nc" id="L243">		candidateToInsert.setDomicileCity(requestCandidateCustom.getDomicileCity());</span>
<span class="nc" id="L244">		candidateToInsert.setStudyQualification(requestCandidateCustom.getStudyQualification());</span>
<span class="nc" id="L245">		candidateToInsert.setGraduate(requestCandidateCustom.getGraduate());</span>
<span class="nc" id="L246">		candidateToInsert.setHighGraduate(requestCandidateCustom.getHighGraduate());</span>
<span class="nc" id="L247">		candidateToInsert.setStillHighStudy(requestCandidateCustom.getStillHighStudy());</span>
<span class="nc" id="L248">		candidateToInsert.setMobile(requestCandidateCustom.getMobile());</span>
<span class="nc" id="L249">		candidateToInsert.setEmail(requestCandidateCustom.getEmail());</span>
<span class="nc" id="L250">		candidateToInsert.setFirstname(requestCandidateCustom.getFirstname());</span>
<span class="nc" id="L251">		candidateToInsert.setLastname(requestCandidateCustom.getLastname());</span>
<span class="nc" id="L252">		candidateToInsert.setTechnicalNote(requestCandidateCustom.getNote());</span>
<span class="nc" id="L253">		candidateToInsert.setRegdate(LocalDateTime.now());</span>
<span class="nc" id="L254">		candidateToInsert.setCourseCode(coursePageService.checkCoursePageCode(requestCandidateCustom.getCourseCode()));</span>
<span class="nc" id="L255">		candidateToInsert.setCandidacyDateTime(LocalDateTime.now());</span>
<span class="nc" id="L256">		candidateToInsert.setCandidateStatusCode(CandidateStates.DEFAULT_INSERTING_STATUS_CODE);</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">		if (requestCandidateCustom.getCvExternalPath() != null) {</span>

			try {
<span class="nc" id="L260">				logger.info(&quot;createNewCandidate - DEBUG - inserting cv document file&quot;);</span>
<span class="nc" id="L261">				String cvExternalPathFileName = uploadFile(requestCandidateCustom.getFiles()[1], buildNewFileName(requestCandidateCustom.getEmail()));</span>
<span class="nc" id="L262">				logger.info(&quot;createNewCandidate - DEBUG - cvExternalPathFileName:&quot; + cvExternalPathFileName);</span>
<span class="nc" id="L263">				candidateToInsert.setCvExternalPath(cvExternalPathFileName);</span>
<span class="nc" id="L264">			} catch (Exception e) {</span>
<span class="nc" id="L265">				logger.error(&quot;Error&quot;, e);</span>
<span class="nc" id="L266">			}</span>
		}
<span class="nc bnc" id="L268" title="All 2 branches missed.">		if (requestCandidateCustom.getImgpath() != null) {</span>

			try {
<span class="nc" id="L271">				logger.info(&quot;createNewCandidate - DEBUG - inserting profile image file&quot;);</span>
<span class="nc" id="L272">				String profileImgFileName = uploadFile(requestCandidateCustom.getFiles()[0], buildNewFileName(requestCandidateCustom.getEmail()));</span>
<span class="nc" id="L273">				logger.info(&quot;createNewCandidate - DEBUG - profileImgFileName:&quot; + profileImgFileName);</span>
<span class="nc" id="L274">				candidateToInsert.setImgpath(profileImgFileName);</span>
<span class="nc" id="L275">			} catch (Exception e) {</span>
<span class="nc" id="L276">				logger.error(&quot;Error&quot;, e);</span>
<span class="nc" id="L277">			}</span>

		}
<span class="nc" id="L280">		return insert(candidateToInsert);</span>

	}
	
	/*
	 * Provide to save file
	 */
	private String uploadFile (MultipartFile file, String candidateFileName) throws IOException {
<span class="nc" id="L288">		logger.info(&quot;uploadFile - START&quot;);</span>

<span class="nc" id="L290">		StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L291">		String fileNameToReturn = null ;</span>

//		if (file.isEmpty()) {
//			continue;
//		}
<span class="nc" id="L296">		String uploadFilePath = null;</span>
<span class="nc" id="L297">		logger.info(&quot;uploadFile - DEBUG 2 - file.getOriginalFilename(): &quot; + file.getOriginalFilename());</span>
<span class="nc" id="L298">		StringTokenizer st = new StringTokenizer(file.getOriginalFilename(), &quot;.&quot;);</span>
<span class="nc" id="L299">		String name = new String(file.getOriginalFilename().substring(0, file.getOriginalFilename().lastIndexOf(&quot;.&quot;)));</span>
//		String name = st.nextToken();
<span class="nc" id="L301">		String extension = new String(file.getOriginalFilename().substring(file.getOriginalFilename().lastIndexOf(&quot;.&quot;)+1));</span>
//		String extension = st.nextToken();
<span class="nc" id="L303">		String fileName = file.getOriginalFilename();</span>
<span class="nc" id="L304">		logger.info(&quot;uploadFile - DEBUG 2.5 - extension: &quot; + extension);</span>
<span class="nc" id="L305">		fileNameToReturn = candidateFileName + &quot;.&quot; + extension;</span>
<span class="nc" id="L306">		uploadFilePath = File.separatorChar + fileNameToReturn;</span>
<span class="nc bnc" id="L307" title="All 6 branches missed.">		if ((fileName.endsWith(&quot;jpg&quot;))||(fileName.endsWith(&quot;jpeg&quot;))||(fileName.endsWith(&quot;png&quot;))||</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">				(fileName.endsWith(&quot;gif&quot;)) ){</span>
		
//		if (fileName.endsWith(&quot;jpg&quot;)) {
//			extension = &quot;.jpg&quot;;
//			uploadFilePath = IMG_DIR + File.pathSeparator + candidateFileName + file.getOriginalFilename();
//			nameIdData[0] = candidateFileName + extension;
//			logger.info(&quot;uploadFile - DEBUG 2.1 - nameIdData[0]: &quot; + nameIdData[0]);
<span class="nc" id="L315">			uploadFilePath = IMG_DIR + uploadFilePath ;</span>
//		} else if (fileName.endsWith(&quot;jpeg&quot;)) {
//			extension = &quot;.jpeg&quot;;
//			uploadFilePath = IMG_DIR + File.pathSeparator + candidateFileName + file.getOriginalFilename();
//			nameIdData[0] = candidateFileName + extension;
//			logger.info(&quot;uploadFile - DEBUG 2.2 - nameIdData[0]: &quot; + nameIdData[0]);
//			uploadFilePath = IMG_DIR + uploadFilePath;
//		} else if (fileName.endsWith(&quot;png&quot;)) {
//			extension = &quot;.png&quot;;
//			uploadFilePath = IMG_DIR + File.pathSeparator + candidateFileName + file.getOriginalFilename();
//			nameIdData[0] = candidateFileName + extension;
//			logger.info(&quot;uploadFile - DEBUG 2.3 - nameIdData[0]: &quot; + nameIdData[0]);
//			uploadFilePath = IMG_DIR + uploadFilePath;
<span class="nc bnc" id="L328" title="All 8 branches missed.">		} else if ((fileName.endsWith(&quot;docx&quot;)) || (fileName.endsWith(&quot;doc&quot;)) || (fileName.endsWith(&quot;pdf&quot;)) || (fileName.endsWith(&quot;odt&quot;))) {</span>
//			extension = &quot;.docx&quot;;
//			nameIdData[1] = candidateFileName + extension;
//			logger.info(&quot;uploadFile - DEBUG 2.4 - nameIdData[1]: &quot; + nameIdData[1]);
//			uploadFilePath = CV_DIR + uploadFilePath;
//		} else if (fileName.endsWith(&quot;doc&quot;)) {
////			extension = &quot;.doc&quot;;
////			nameIdData[1] = candidateFileName + extension;
////			logger.info(&quot;uploadFile - DEBUG 2.5 - nameIdData[1]: &quot; + nameIdData[1]);
//			uploadFilePath = CV_DIR + uploadFilePath;
//		} else if (fileName.endsWith(&quot;pdf&quot;)) {
////			extension = &quot;.pdf&quot;;
////			nameIdData[1] = candidateFileName + extension;
////			logger.info(&quot;uploadFile - DEBUG 2.6 - nameIdData[1]: &quot; + nameIdData[1]);
<span class="nc" id="L342">			uploadFilePath = CV_DIR + uploadFilePath;</span>
		}
		
//		logger.info(&quot;uploadFile - DEBUG 2 - nameIdData[0]: &quot; + nameIdData[0]);
<span class="nc" id="L346">		logger.info(&quot;uploadFile - DEBUG 3 - uploadFilePath: &quot; + uploadFilePath);</span>
<span class="nc" id="L347">		byte[] bytes = file.getBytes();</span>
<span class="nc" id="L348">		logger.info(&quot;uploadFile - DEBUG 3.5 - bytes.length: &quot; + bytes.length);</span>
<span class="nc" id="L349">		FileOutputStream fos = new FileOutputStream(uploadFilePath);</span>
<span class="nc" id="L350">		fos.write(bytes);</span>

<span class="nc" id="L352">		logger.info(&quot;uploadFile - END - fileNameToReturn: {}&quot;, fileNameToReturn);</span>
<span class="nc" id="L353">		return fileNameToReturn;</span>
	}
	/*
	 * Provide to save file
	 */
	private String[] uploadFile(MultipartFile[] files, String candidateFileName) throws IOException {
<span class="nc" id="L359">		logger.info(&quot;uploadFile - START&quot;);</span>
		// Make sure directory exists!
<span class="nc" id="L361">		File uploadImgDir = new File(IMG_DIR);</span>
<span class="nc" id="L362">		uploadImgDir.mkdirs();</span>
<span class="nc" id="L363">		File uploadCvDir = new File(CV_DIR);</span>
<span class="nc" id="L364">		uploadCvDir.mkdirs();</span>

<span class="nc" id="L366">		StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L367">		logger.info(&quot;uploadFile - DEBUG 1&quot;);</span>
<span class="nc" id="L368">		String[] nameIdData = new String[2];</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">		for (MultipartFile file : files) {</span>

<span class="nc bnc" id="L371" title="All 2 branches missed.">			if (file.isEmpty()) {</span>
<span class="nc" id="L372">				continue;</span>
			}
<span class="nc" id="L374">			String uploadFilePath = null;</span>
<span class="nc" id="L375">			logger.info(&quot;uploadFile - DEBUG 2 - file.getOriginalFilename(): &quot; + file.getOriginalFilename());</span>
<span class="nc" id="L376">			StringTokenizer st = new StringTokenizer(file.getOriginalFilename(), &quot;.&quot;);</span>
<span class="nc" id="L377">			String name = st.nextToken();</span>
<span class="nc" id="L378">			String extension = st.nextToken();</span>
<span class="nc" id="L379">			String fileName = file.getOriginalFilename();</span>

<span class="nc bnc" id="L381" title="All 2 branches missed.">			if (fileName.endsWith(&quot;jpg&quot;)) {</span>
<span class="nc" id="L382">				extension = &quot;.jpg&quot;;</span>
<span class="nc" id="L383">				uploadFilePath = IMG_DIR + File.pathSeparator + candidateFileName + file.getOriginalFilename();</span>
<span class="nc" id="L384">				nameIdData[0] = candidateFileName + extension;</span>
<span class="nc" id="L385">				logger.info(&quot;uploadFile - DEBUG 2.1 - nameIdData[0]: &quot; + nameIdData[0]);</span>
<span class="nc" id="L386">				uploadFilePath = IMG_DIR + File.separatorChar + nameIdData[0];</span>
			} 
<span class="nc bnc" id="L388" title="All 2 branches missed.">			if (fileName.endsWith(&quot;jpeg&quot;)) {</span>
<span class="nc" id="L389">				extension = &quot;.jpeg&quot;;</span>
<span class="nc" id="L390">				uploadFilePath = IMG_DIR + File.pathSeparator + candidateFileName + file.getOriginalFilename();</span>
<span class="nc" id="L391">				nameIdData[0] = candidateFileName + extension;</span>
<span class="nc" id="L392">				logger.info(&quot;uploadFile - DEBUG 2.2 - nameIdData[0]: &quot; + nameIdData[0]);</span>
<span class="nc" id="L393">				uploadFilePath = IMG_DIR + File.separatorChar + nameIdData[0];</span>
			}
<span class="nc bnc" id="L395" title="All 2 branches missed.">			if (fileName.endsWith(&quot;png&quot;)) {</span>
<span class="nc" id="L396">				extension = &quot;.png&quot;;</span>
<span class="nc" id="L397">				uploadFilePath = IMG_DIR + File.pathSeparator + candidateFileName + file.getOriginalFilename();</span>
<span class="nc" id="L398">				nameIdData[0] = candidateFileName + extension;</span>
<span class="nc" id="L399">				logger.info(&quot;uploadFile - DEBUG 2.3 - nameIdData[0]: &quot; + nameIdData[0]);</span>
<span class="nc" id="L400">				uploadFilePath = IMG_DIR + File.separatorChar + nameIdData[0];</span>
			}
<span class="nc bnc" id="L402" title="All 2 branches missed.">			if (fileName.endsWith(&quot;docx&quot;)) {</span>
<span class="nc" id="L403">				extension = &quot;.docx&quot;;</span>
<span class="nc" id="L404">				nameIdData[1] = candidateFileName + extension;</span>
<span class="nc" id="L405">				logger.info(&quot;uploadFile - DEBUG 2.4 - nameIdData[1]: &quot; + nameIdData[1]);</span>
<span class="nc" id="L406">				uploadFilePath = CV_DIR + File.separatorChar + nameIdData[1];</span>
			}
<span class="nc bnc" id="L408" title="All 2 branches missed.">			if (fileName.endsWith(&quot;doc&quot;)) {</span>
<span class="nc" id="L409">				extension = &quot;.doc&quot;;</span>
<span class="nc" id="L410">				nameIdData[1] = candidateFileName + extension;</span>
<span class="nc" id="L411">				logger.info(&quot;uploadFile - DEBUG 2.5 - nameIdData[1]: &quot; + nameIdData[1]);</span>
<span class="nc" id="L412">				uploadFilePath = CV_DIR + File.separatorChar + nameIdData[1];</span>
			}
<span class="nc bnc" id="L414" title="All 2 branches missed.">			if (fileName.endsWith(&quot;pdf&quot;)) {</span>
<span class="nc" id="L415">				extension = &quot;.pdf&quot;;</span>
<span class="nc" id="L416">				nameIdData[1] = candidateFileName + extension;</span>
<span class="nc" id="L417">				logger.info(&quot;uploadFile - DEBUG 2.6 - nameIdData[1]: &quot; + nameIdData[1]);</span>
<span class="nc" id="L418">				uploadFilePath = CV_DIR + File.separatorChar + nameIdData[1];</span>
			}

<span class="nc" id="L421">			logger.info(&quot;uploadFile - DEBUG 3 - uploadFilePath: &quot; + uploadFilePath);</span>
<span class="nc" id="L422">			byte[] bytes = file.getBytes();</span>
<span class="nc" id="L423">			logger.info(&quot;uploadFile - DEBUG 3.5 - bytes.length: &quot; + bytes.length);</span>
<span class="nc" id="L424">			FileOutputStream fos = new FileOutputStream(uploadFilePath);</span>
<span class="nc" id="L425">			fos.write(bytes);</span>

<span class="nc" id="L427">			logger.info(&quot;uploadFile - DEBUG 5&quot;);</span>
		}
<span class="nc" id="L429">		logger.info(&quot;uploadFile - END - nameIdData: {}&quot;, Arrays.toString(nameIdData));</span>
<span class="nc" id="L430">		return nameIdData;</span>
	}
	
	
	/**
	 * Invoked by CandidateCustomController.update, provides retrieve existent
	 * entity, uploads new image and new cv files, and fill the old entity with new
	 * properties, than call CandidateService.update method to persist the new
	 * entity.
	 * 
	 * @param id,                long number id of candidate to update
	 * @param candidateToUpdate, RequestUpdateCandidateCustom instance that contains
	 *                           new parameters to update.
	 * 
	 * @return Candidate, updated entity
	 */
	public Candidate updateCandidate(Long id, RequestUpdateCandidateCustom requestCandidateToUpdate) throws CandidateNotFoundException {
<span class="nc" id="L447">		logger.info(&quot;updateCandidate - START - with requestCandidateToUpdate {}&quot;, requestCandidateToUpdate);</span>

<span class="nc" id="L449">		Optional&lt;Candidate&gt; optCandidate = getById(id);</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">		if (optCandidate.isEmpty()) {</span>
<span class="nc" id="L451">			throw new CandidateNotFoundException(&quot;User not found, during candidate updating process.&quot;);</span>
		} else {// optCandidate.isPresent

<span class="nc" id="L454">			Candidate candidateToUpdate = optCandidate.get();</span>
//			Candidate candidateToUpdate = new Candidate();
//			candidateToUpdate.setUserId(requestCandidateToUpdate.getInsertedBy());
//			candidateToUpdate.setInsertedBy(requestCandidateToUpdate.getInsertedBy());
<span class="nc" id="L458">			candidateToUpdate.setDomicileCity(requestCandidateToUpdate.getDomicileCity());</span>
<span class="nc" id="L459">			candidateToUpdate.setStudyQualification(requestCandidateToUpdate.getStudyQualification());</span>
<span class="nc" id="L460">			candidateToUpdate.setGraduate(requestCandidateToUpdate.getGraduate());</span>
<span class="nc" id="L461">			candidateToUpdate.setHighGraduate(requestCandidateToUpdate.getHighGraduate());</span>
<span class="nc" id="L462">			candidateToUpdate.setStillHighStudy(requestCandidateToUpdate.getStillHighStudy());</span>
<span class="nc" id="L463">			candidateToUpdate.setMobile(requestCandidateToUpdate.getMobile());</span>
<span class="nc" id="L464">			candidateToUpdate.setEmail(requestCandidateToUpdate.getEmail());</span>
<span class="nc" id="L465">			candidateToUpdate.setFirstname(requestCandidateToUpdate.getFirstname());</span>
<span class="nc" id="L466">			candidateToUpdate.setLastname(requestCandidateToUpdate.getLastname());</span>
<span class="nc" id="L467">			candidateToUpdate.setTechnicalNote(requestCandidateToUpdate.getNote());</span>
<span class="nc" id="L468">			candidateToUpdate.setCandidateStatusCode(requestCandidateToUpdate.getCandidateStatusCode());</span>
<span class="nc" id="L469">			candidateToUpdate.setCourseCode(requestCandidateToUpdate.getPositionCode());</span>
//			candidateToUpdate.setRegdate(LocalDateTime.now());
<span class="nc" id="L471">			Date inputDate = requestCandidateToUpdate.getDateOfBirth();</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">			if (inputDate != null) {</span>
<span class="nc" id="L473">				LocalDate dateToDB = inputDate.toInstant().atZone(ZoneId.systemDefault()).toLocalDate();</span>
<span class="nc" id="L474">				candidateToUpdate.setDateOfBirth(dateToDB);</span>
			}
			//
			//UPDATE CV - START
			//
<span class="nc" id="L479">			String oldCV = requestCandidateToUpdate.getOldCV();</span>
<span class="nc" id="L480">			String newCV = requestCandidateToUpdate.getCvExternalPath();</span>
			/*
			// se si oldCV si newCV
			if (newCV != null &amp;&amp; !oldCV.equals(&quot;null&quot;) &amp;&amp; !newCV.equals(&quot;null&quot;)) {
				try {
					// save newCv
					String[] nameIdData = uploadFile(requestCandidateToUpdate.getFiles(), &quot;&quot;+requestCandidateToUpdate.getEmail().hashCode());
					logger.info(&quot;nameIdData:&quot; + nameIdData[1]);
					candidateToUpdate.setCvExternalPath(nameIdData[1]);
					// delete oldCV
					String sPath = CV_DIR + File.separatorChar + requestCandidateToUpdate.getOldCV();
					Path path = Paths.get(sPath);
					Files.delete(path);
				} catch (IOException e) {
					logger.error(&quot;Error&quot;, e);
				}
			}

			// se no oldCV si newCV
			if (newCV != null &amp;&amp; oldCV.equals(&quot;null&quot;) &amp;&amp; !newCV.equals(&quot;null&quot;)) {
//				cvIsPresent = true;
//				String cvPath = &quot;curriculumvitae/&quot; +candidateCustom.getUserId()+ candidateCustom.getCvExternalPath();
				try {
					// save firstCV
					String[] nameIdData = uploadFile(requestCandidateToUpdate.getFiles(),
							&quot;&quot;+requestCandidateToUpdate.getEmail().hashCode());
					logger.info(&quot;nameIdData:&quot; + nameIdData[1]);
					candidateToUpdate.setCvExternalPath(nameIdData[1]);

				} catch (IOException e) {
					logger.error(&quot;Error&quot;, e);
				}

			}
			*/
<span class="nc bnc" id="L515" title="All 4 branches missed.">			if (newCV != null &amp;&amp; !newCV.equals(&quot;null&quot;)) {</span>
<span class="nc bnc" id="L516" title="All 4 branches missed.">				if (oldCV != null &amp;&amp; !oldCV.equals(&quot;null&quot;)) {</span>
<span class="nc" id="L517">					String filePathToDelete = CV_DIR + File.separatorChar + requestCandidateToUpdate.getOldCV();</span>
					try {						
<span class="nc" id="L519">						Path path = Paths.get(filePathToDelete);</span>
<span class="nc" id="L520">						Files.delete(path);</span>
<span class="nc" id="L521">					} catch (IOException e) {</span>
<span class="nc" id="L522">						logger.error(&quot;Error in deleting old cv file: {}&quot;, filePathToDelete,  e);</span>
<span class="nc" id="L523">					}</span>
				}
				try {
<span class="nc" id="L526">					String[] nameIdData = uploadFile(requestCandidateToUpdate.getFiles(), &quot;&quot; + buildNewFileName (requestCandidateToUpdate.getEmail()));</span>
<span class="nc" id="L527">					logger.info(&quot;nameIdData:&quot; + nameIdData[1]);</span>
<span class="nc" id="L528">					candidateToUpdate.setCvExternalPath(nameIdData[1]);</span>

<span class="nc" id="L530">				} catch (IOException e) {</span>
<span class="nc" id="L531">					logger.error(&quot;Error&quot;, e);</span>
<span class="nc" id="L532">				}</span>

			}
			
			//
			//UPDATE CV - END
			//
			
			//
			//UPDATE PROFILE IMG - START
			//
<span class="nc" id="L543">			String oldImg = requestCandidateToUpdate.getOldImg();</span>
<span class="nc" id="L544">			String newImg = requestCandidateToUpdate.getImgpath();</span>

			// se si oldImg e si newImg
<span class="nc bnc" id="L547" title="All 6 branches missed.">			if (newImg != null &amp;&amp; !oldImg.equals(&quot;null&quot;) &amp;&amp; !newImg.equals(&quot;null&quot;)) {</span>
//				imgIsPresent = true;
//				String imgPath = &quot;img/&quot; +candidateCustom.getUserId()+candidateCustom.getImgpath();
				try {

					// save newImg
<span class="nc" id="L553">					String[] nameIdData = uploadFile(requestCandidateToUpdate.getFiles(), buildNewFileName(requestCandidateToUpdate.getEmail()));</span>
<span class="nc" id="L554">					logger.info(&quot;nameIdData:&quot; + nameIdData[0]);</span>
<span class="nc" id="L555">					candidateToUpdate.setImgpath(nameIdData[0]);</span>

					// delete oldImg
					//String sPath = IMG_DIR + File.separatorChar + requestCandidateToUpdate.getOldImg();
<span class="nc" id="L559">					String sPath = IMG_DIR + File.separatorChar + oldImg;</span>
<span class="nc" id="L560">					Path path = Paths.get(sPath);</span>
<span class="nc" id="L561">					Files.delete(path);</span>

<span class="nc" id="L563">				} catch (IOException e) {</span>
<span class="nc" id="L564">					logger.error(&quot;Error&quot;, e);</span>
<span class="nc" id="L565">				}</span>

			}

			// se no oldImg si newImg
<span class="nc bnc" id="L570" title="All 6 branches missed.">			if (newImg != null &amp;&amp; oldImg.equals(&quot;null&quot;) &amp;&amp; !newImg.equals(&quot;null&quot;)) {</span>
//				imgIsPresent = true;
//				String imgPath = &quot;img/&quot; +candidateCustom.getUserId()+ candidateCustom.getImgpath();

				try {

					// save firstNewImg
<span class="nc" id="L577">					String[] nameIdData = uploadFile(requestCandidateToUpdate.getFiles(), buildNewFileName(requestCandidateToUpdate.getEmail()));</span>
<span class="nc" id="L578">					logger.info(&quot;nameIdData:&quot; + nameIdData[0]);</span>
<span class="nc" id="L579">					candidateToUpdate.setImgpath(nameIdData[0]);</span>

<span class="nc" id="L581">				} catch (IOException e) {</span>
<span class="nc" id="L582">					logger.error(&quot;Error&quot;, e);</span>
<span class="nc" id="L583">				}</span>

			}
			//
			// UPDATE PROFILE IMG - END
			//
			
			
			
<span class="nc" id="L592">			return update(candidateToUpdate);</span>

		}
	}
	
	private String buildNewFileName (String email) {
<span class="nc" id="L598">		String returnName = email ;</span>
<span class="nc" id="L599">		returnName = returnName.hashCode() + &quot;-&quot; + new Random().nextInt();</span>
<span class="nc" id="L600">		return returnName ;</span>
	}
	
	/**
	 * Invoked by CandidateCustomController.deleteCandidate method, provides retrieve existent
	 * entity, delete profile image and profile cv files, than call CandidateService.delete method 
	 * to delete entity from table.
	 * 
	 * @param id,                long number id of candidate to update
	 * 
	 */
	public void deleteCandidate(long id) throws CandidateNotFoundException {
<span class="nc" id="L612">		logger.info(&quot;deleteCandidate - START - with id {}&quot;, id);</span>

<span class="nc" id="L614">		Optional&lt;Candidate&gt; optCandidate = getById(id);</span>
<span class="nc bnc" id="L615" title="All 2 branches missed.">		if (optCandidate.isEmpty()) {</span>
<span class="nc" id="L616">			throw new CandidateNotFoundException(&quot;User not found, during candidate updating process.&quot;);</span>
		} else {
<span class="nc" id="L618">			Candidate candidateToDelete = optCandidate.get();</span>
<span class="nc" id="L619">			String oldCV = candidateToDelete.getCvExternalPath();</span>
			
<span class="nc bnc" id="L621" title="All 4 branches missed.">			if (oldCV != null &amp;&amp; !oldCV.equals(&quot;null&quot;)) {</span>
<span class="nc" id="L622">				String filePathToDelete = CV_DIR + File.separatorChar + oldCV;</span>
				try {						
<span class="nc" id="L624">					Path path = Paths.get(filePathToDelete);</span>
<span class="nc" id="L625">					Files.delete(path);</span>
<span class="nc" id="L626">				} catch (NoSuchFileException e) {</span>
<span class="nc" id="L627">					logger.error(&quot;File non trovato. Non è stato possibile cancellarlo. {}&quot;, filePathToDelete);</span>
<span class="nc" id="L628">				} catch (Exception e) {</span>
<span class="nc" id="L629">					logger.error(&quot;Error in deleting old cv file: {}&quot;, filePathToDelete,  e);</span>
<span class="nc" id="L630">				}</span>
			}

<span class="nc" id="L633">			String oldImg = candidateToDelete.getImgpath();</span>
<span class="nc bnc" id="L634" title="All 4 branches missed.">			if (oldImg != null &amp;&amp; !oldImg.equals(&quot;null&quot;)) {</span>
<span class="nc" id="L635">				String sPath = null ;</span>
				try {
<span class="nc" id="L637">					sPath = IMG_DIR + File.separatorChar + oldImg;</span>
<span class="nc" id="L638">					Path path = Paths.get(sPath);</span>
<span class="nc" id="L639">					Files.delete(path);</span>

<span class="nc" id="L641">				} catch (NoSuchFileException e) {</span>
<span class="nc" id="L642">					logger.error(&quot;File non trovato. Non è stato possibile cancellarlo. {}&quot;, sPath);</span>
<span class="nc" id="L643">				} catch (Exception e) {</span>
<span class="nc" id="L644">					logger.error(&quot;Error&quot;, e);</span>
<span class="nc" id="L645">				}</span>

			}
			
			
			
			

		}
<span class="nc" id="L654">		deleteById(id);</span>
<span class="nc" id="L655">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>